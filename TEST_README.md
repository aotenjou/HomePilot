# 设备权限系统单元测试

## 📋 测试概述

本项目为设备权限系统创建了完整的单元测试，重点测试不同角色（房主、家庭成员、访客）对设备的访问权限差异。

## 🧪 测试文件

### 1. DevicePermissionServiceTest.java
核心服务层测试类，测试 `DevicePermissionServiceImpl` 的所有方法：

- **房主权限测试** - 验证房主可以访问所有设备
- **家庭成员权限测试** - 验证家庭成员基于角色默认权限访问设备
- **访客权限测试** - 验证访客只能访问特定设备类型且只能执行查看操作
- **自定义权限测试** - 验证用户自定义权限可以覆盖角色默认权限

### 2. DevicePermissionControllerTest.java
控制器层测试类，测试 `GuestPermissionController` 的接口：

- **访客设备列表获取**
- **访客权限检查**
- **权限信息获取**
- **错误处理测试**

## 🚀 运行测试

### 方法一：使用批处理脚本（推荐）
```bash
# Windows系统
run-tests.bat

# 或手动执行
mvn clean compile test-compile test -Dtest=DevicePermissionServiceTest,DevicePermissionControllerTest
```

### 方法二：使用Maven命令
```bash
# 运行所有测试
mvn test

# 只运行权限相关测试
mvn test -Dtest=DevicePermissionServiceTest
mvn test -Dtest=DevicePermissionControllerTest

# 运行单个测试方法
mvn test -Dtest=DevicePermissionServiceTest#testHostPermission_ShouldAccessAllDevices
```

### 方法三：使用IDE
在IDE中直接运行测试类或测试方法。

## 📊 测试覆盖的场景

### 角色权限测试
1. **HOST (房主)** - 可以访问所有设备和执行所有操作
2. **MEMBER (家庭成员)** - 根据角色默认权限访问设备
3. **GUEST (访客)** - 受限访问：
   - 只能访问设备类型：窗户(5L)、监控摄像头(6L)
   - 只能执行查看操作（操作ID ≤ 2）
   - 不能执行控制操作（操作ID > 2）

### 权限覆盖测试
- **自定义权限优先级** - 用户自定义权限覆盖角色默认权限
- **权限检查流程** - 完整的权限验证逻辑

### 边界情况测试
- **无效用户** - 处理不存在的用户
- **无权限设备** - 处理用户无权限访问的设备
- **异常处理** - 测试各种异常情况的处理

## 🔧 测试配置

测试使用独立的配置文件：
- **配置文件**: `src/test/resources/application-test.yml`
- **数据库**: H2内存数据库（测试专用）
- **日志级别**: DEBUG（便于调试）

## 📈 测试结果说明

### 成功的测试标准
- ✅ 房主可以访问任何设备
- ✅ 家庭成员根据角色权限访问设备
- ✅ 访客只能访问指定设备类型
- ✅ 访客只能执行查看操作
- ✅ 自定义权限正确覆盖默认权限
- ✅ 所有异常情况都被正确处理

### 测试报告
运行测试后，可以在 `target/surefire-reports/` 目录下查看详细的测试报告。

## 🛠️ 故障排除

### 常见问题
1. **测试失败**: 检查是否正确配置了测试环境
2. **依赖问题**: 确保所有测试依赖都已正确安装
3. **数据库问题**: 测试使用H2内存数据库，无需额外配置

### 调试建议
1. 查看测试日志输出
2. 使用IDE的调试功能逐步执行测试
3. 检查Mock对象的配置是否正确

## 📝 测试扩展

### 添加新测试
1. 在现有测试类中添加新的 `@Test` 方法
2. 遵循现有的命名约定和结构
3. 使用Mockito进行依赖注入

### 测试数据管理
- 测试数据在每个测试方法中独立创建
- 避免测试方法间的相互依赖
- 使用有意义的测试数据名称

## 🎯 测试目标达成

通过这些测试，我们验证了：

1. **✅ 角色权限系统** - 不同角色有不同的设备访问权限
2. **✅ 访客限制机制** - 访客只能访问部分设备和执行有限操作
3. **✅ 权限覆盖机制** - 用户自定义权限可以覆盖角色默认权限
4. **✅ 安全边界** - 系统正确处理各种边界情况和异常

这些测试确保了设备权限系统的稳定性和安全性。
