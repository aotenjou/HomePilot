### 传感器联动自动化使用说明

本说明介绍系统如何基于人体感应与温度传感器的 MQTT 上报，自动控制同房间内的灯光与风扇。

### 功能概述
- **人体感应触发**: 人体传感器上报有人（value>0）时，自动打开同房间内的“灯”。
- **温度触发**: 温度传感器上报温度值大于 30 时，自动打开同房间内的“风扇”。
- 控制指令通过 `MqttSendmessageService` 发送，操作指令使用字符串 "1"（对应 Operation: TurnOn）。

### 前置条件
- 已正确配置 MQTT 连接（参考 `application-byt.yml` 的 `spring.mqtt` 配置，及 `MqttConsumerConfig` 订阅主题）。
- 设备与传感器已录入，并正确设置 `room_id`（同一房间的传感器与执行器需要一致）。
- 设备类型表 `Device_Type` 中存在如下中文名称（用于匹配）：
  - 人体相关：名称包含“人体”
  - 温度传感器：名称包含“温度”
  - 灯：名称包含“灯”
  - 风扇：名称包含“风扇”
  如名称不同，请修改类型名或在代码中调整匹配逻辑。

### 传感器上报消息格式
- 消息 payload 约定：
  - 前 4 位为设备 ID（例如：`0001`），
  - 第 5 位为任意分隔符（如 `:` 或 `-`），
  - 第 6 位起为数值部分（例如：`30` 或 `1`）。
- 示例：
  - 人体感应上报：`0007:1`（设备 7，检测到有人）
  - 温度上报：`0012:31`（设备 12，当前温度 31）
若设备上报格式不同，请在 `MqttConsumerCallBack#messageArrived` 中调整解析（`substring`）逻辑。

### 触发逻辑位置
- 文件：`src/main/java/com/example/manager/mqtt/Callback/MqttConsumerCallBack.java`
- 方法：`messageArrived`
- 关键流程：
  1) 解析 payload，写入 `Mqtt_data`，刷新设备最后活跃时间。
  2) 根据消息对应的传感器设备，获取其 `room_id`/`home_id` 与 `type`。
  3) 若为“人体”类型且 `value>0`，在同房间内查找“灯”并发送开启指令。
  4) 若为“温度”类型且 `value>30`，在同房间内查找“风扇”并发送开启指令。

### 如何修改阈值或匹配规则
- 修改人体触发条件：将 `value>0` 改为你需要的阈值或布尔判断。
- 修改温度阈值：将 `value>30` 改为期望温度阈值。
- 修改设备类型匹配：将对类型名的 `contains("灯"/"风扇"/"人体"/"温度")` 调整为你的命名；或改为按类型 ID 常量匹配，避免中文名称变更影响逻辑。

### 运行与验证
1) 启动后端服务，保证 MQTT 消费端已连接并订阅。
2) 让人体传感器或温度传感器设备按约定格式上报。
3) 观察日志是否打印收到消息与联动执行；同时验证灯或风扇是否被打开。

### 常见问题排查
- 收不到自动化动作：检查传感器 payload 是否满足格式（前 4 位为设备 ID、分隔符、数值）。
- 找不到同房间执行器：确认执行器设备的 `room_id` 与传感器一致，且设备类型名称匹配。
- 指令未下发：检查 MQTT Provider 连接是否成功；以及 `MqttSendmessageService` 是否能正常发布。

### 可扩展建议
- 以设备类型 ID 常量替代中文名称匹配，增强鲁棒性。
- 扩展灯光“调光”、风扇“调速”逻辑：基于传感器数值计算目标档位并发送对应操作 ID。


