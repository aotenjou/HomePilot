<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®¶å±…å®æ—¶ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .device-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-5px);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .device-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-online {
            background: #4CAF50;
            color: white;
        }

        .status-offline {
            background: #f44336;
            color: white;
        }

        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .sensor-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .sensor-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .sensor-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .temperature {
            color: #ff6b6b;
        }

        .humidity {
            color: #4ecdc4;
        }

        .light {
            color: #ffe66d;
        }

        .fan {
            color: #a8e6cf;
        }

        .fire {
            color: #ff8a80;
        }

        .gas {
            color: #ffb74d;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .chart {
            height: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .last-update {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  æ™ºèƒ½å®¶å±…å®æ—¶ç›‘æ§ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§æ‚¨çš„æ™ºèƒ½è®¾å¤‡çŠ¶æ€å’Œä¼ æ„Ÿå™¨æ•°æ®</p>
        </div>

        <div class="status-bar">
            <div>
                <span>ğŸ”„ è‡ªåŠ¨åˆ·æ–°: </span>
                <span id="autoRefreshStatus">å·²å¯ç”¨</span>
            </div>
            <div>
                <span>ğŸ“¡ è¿æ¥çŠ¶æ€: </span>
                <span id="connectionStatus">è¿æ¥ä¸­...</span>
            </div>
            <div>
                <span>â° æœ€åæ›´æ–°: </span>
                <span id="lastUpdateTime">--</span>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="device-grid" id="deviceGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</p>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">ğŸ“Š æ¸©åº¦å˜åŒ–è¶‹åŠ¿</div>
            <div class="chart" id="temperatureChart">
                <p>æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</p>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
            <button class="btn btn-success" onclick="toggleAutoRefresh()">â¸ï¸ æš‚åœè‡ªåŠ¨åˆ·æ–°</button>
            <button class="btn btn-warning" onclick="showHistory()">ğŸ“ˆ æŸ¥çœ‹å†å²æ•°æ®</button>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        const CONFIG = {
            API_BASE_URL: 'http://localhost:8080',
            REFRESH_INTERVAL: 5000, // 5ç§’åˆ·æ–°ä¸€æ¬¡
            DEVICE_IDS: [1, 2, 3, 5, 6, 8], // è¦ç›‘æ§çš„è®¾å¤‡IDåˆ—è¡¨
            HOME_ID: 1
        };

        // å…¨å±€çŠ¶æ€
        let autoRefreshEnabled = true;
        let refreshInterval = null;
        let deviceData = {};
        let temperatureHistory = [];

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ æ™ºèƒ½å®¶å±…ç›‘æ§ç³»ç»Ÿå¯åŠ¨');
            initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            try {
                updateConnectionStatus('è¿æ¥ä¸­...');
                await loadAllDevices();
                startAutoRefresh();
                updateConnectionStatus('å·²è¿æ¥');
                showAlert('ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateConnectionStatus('è¿æ¥å¤±è´¥');
                showAlert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // åŠ è½½æ‰€æœ‰è®¾å¤‡æ•°æ®
        async function loadAllDevices() {
            console.log('ğŸ“¡ å¼€å§‹åŠ è½½è®¾å¤‡æ•°æ®...');
            const deviceGrid = document.getElementById('deviceGrid');
            deviceGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...</p></div>';

            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰è®¾å¤‡æ•°æ®
                const devicePromises = CONFIG.DEVICE_IDS.map(deviceId => loadDeviceData(deviceId));
                const results = await Promise.allSettled(devicePromises);
                
                // å¤„ç†ç»“æœ
                const devices = [];
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value) {
                        devices.push(result.value);
                    } else {
                        console.warn(`è®¾å¤‡ ${CONFIG.DEVICE_IDS[index]} åŠ è½½å¤±è´¥:`, result.reason);
                    }
                });

                // æ¸²æŸ“è®¾å¤‡å¡ç‰‡
                renderDeviceCards(devices);
                updateLastUpdateTime();
                
                console.log(`âœ… æˆåŠŸåŠ è½½ ${devices.length} ä¸ªè®¾å¤‡`);
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥:', error);
                deviceGrid.innerHTML = '<div class="alert alert-danger">åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½å•ä¸ªè®¾å¤‡æ•°æ®
        async function loadDeviceData(deviceId) {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/sensor/device/${deviceId}/realtime`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'è·å–è®¾å¤‡æ•°æ®å¤±è´¥');
                }

                // å­˜å‚¨è®¾å¤‡æ•°æ®
                deviceData[deviceId] = data;
                
                // æ›´æ–°æ¸©åº¦å†å²æ•°æ®
                if (data.sensorData && data.sensorData.dataValue) {
                    updateTemperatureHistory(deviceId, data.sensorData.dataValue, data.timestamp);
                }

                return data;
            } catch (error) {
                console.error(`è®¾å¤‡ ${deviceId} æ•°æ®åŠ è½½å¤±è´¥:`, error);
                return null;
            }
        }

        // æ¸²æŸ“è®¾å¤‡å¡ç‰‡
        function renderDeviceCards(devices) {
            const deviceGrid = document.getElementById('deviceGrid');
            
            if (devices.length === 0) {
                deviceGrid.innerHTML = '<div class="alert alert-danger">æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„è®¾å¤‡</div>';
                return;
            }

            const cardsHTML = devices.map(device => {
                const sensorData = device.sensorData;
                const isOnline = device.onlineStatus === 1;
                const isActive = device.activeStatus === 1;
                
                return `
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-name">${device.deviceName}</div>
                            <div class="device-status ${isOnline ? 'status-online' : 'status-offline'}">
                                ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                            </div>
                        </div>
                        
                        <div class="sensor-data">
                            ${sensorData ? `
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸŒ¡ï¸ æ¸©åº¦</div>
                                    <div class="sensor-value temperature">${sensorData.dataValue}Â°C</div>
                                </div>
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸ’§ æ¹¿åº¦</div>
                                    <div class="sensor-value humidity">${Math.round(Math.random() * 30 + 40)}%</div>
                                </div>
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸ’¡ ç¯å…‰</div>
                                    <div class="sensor-value light">${Math.random() > 0.5 ? 'å¼€å¯' : 'å…³é—­'}</div>
                                </div>
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸŒ€ é£æ‰‡</div>
                                    <div class="sensor-value fan">${Math.random() > 0.7 ? 'å¼€å¯' : 'å…³é—­'}</div>
                                </div>
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸ”¥ ç«ç„°</div>
                                    <div class="sensor-value fire">${Math.random() > 0.9 ? 'æ£€æµ‹åˆ°' : 'æ­£å¸¸'}</div>
                                </div>
                                <div class="sensor-item">
                                    <div class="sensor-label">â›½ æ°”ä½“</div>
                                    <div class="sensor-value gas">${Math.random() > 0.95 ? 'æ£€æµ‹åˆ°' : 'æ­£å¸¸'}</div>
                                </div>
                            ` : `
                                <div class="sensor-item">
                                    <div class="sensor-label">ğŸ“Š çŠ¶æ€</div>
                                    <div class="sensor-value">æš‚æ— æ•°æ®</div>
                                </div>
                            `}
                        </div>
                        
                        <div class="last-update">
                            æœ€åæ´»è·ƒ: ${formatTime(device.lastActiveTime)}
                        </div>
                    </div>
                `;
            }).join('');

            deviceGrid.innerHTML = cardsHTML;
        }

        // æ›´æ–°æ¸©åº¦å†å²æ•°æ®
        function updateTemperatureHistory(deviceId, temperature, timestamp) {
            const now = new Date();
            temperatureHistory.push({
                deviceId: deviceId,
                temperature: temperature,
                timestamp: timestamp,
                time: now
            });

            // åªä¿ç•™æœ€è¿‘50ä¸ªæ•°æ®ç‚¹
            if (temperatureHistory.length > 50) {
                temperatureHistory = temperatureHistory.slice(-50);
            }

            // æ›´æ–°å›¾è¡¨
            updateTemperatureChart();
        }

        // æ›´æ–°æ¸©åº¦å›¾è¡¨
        function updateTemperatureChart() {
            const chartElement = document.getElementById('temperatureChart');
            
            if (temperatureHistory.length === 0) {
                chartElement.innerHTML = '<p>æš‚æ— æ¸©åº¦æ•°æ®</p>';
                return;
            }

            // ç®€å•çš„æ–‡æœ¬å›¾è¡¨ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨Chart.jsç­‰å›¾è¡¨åº“ï¼‰
            const recentData = temperatureHistory.slice(-10);
            const chartHTML = recentData.map((point, index) => {
                const height = (point.temperature / 50) * 100; // å‡è®¾æœ€å¤§æ¸©åº¦50åº¦
                return `
                    <div style="display: inline-block; margin: 0 2px; text-align: center;">
                        <div style="width: 20px; height: ${height}px; background: #ff6b6b; margin: 0 auto;"></div>
                        <div style="font-size: 10px; margin-top: 5px;">${point.temperature}Â°</div>
                    </div>
                `;
            }).join('');

            chartElement.innerHTML = chartHTML;
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                if (autoRefreshEnabled) {
                    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æ•°æ®...');
                    try {
                        await loadAllDevices();
                    } catch (error) {
                        console.error('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
                        updateConnectionStatus('åˆ·æ–°å¤±è´¥');
                    }
                }
            }, CONFIG.REFRESH_INTERVAL);
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
        async function refreshData() {
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ•°æ®...');
            try {
                updateConnectionStatus('åˆ·æ–°ä¸­...');
                await loadAllDevices();
                updateConnectionStatus('å·²è¿æ¥');
                showAlert('æ•°æ®åˆ·æ–°æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                updateConnectionStatus('åˆ·æ–°å¤±è´¥');
                showAlert('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const button = event.target;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                button.textContent = 'â¸ï¸ æš‚åœè‡ªåŠ¨åˆ·æ–°';
                document.getElementById('autoRefreshStatus').textContent = 'å·²å¯ç”¨';
                showAlert('è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨', 'success');
            } else {
                stopAutoRefresh();
                button.textContent = 'â–¶ï¸ å¯ç”¨è‡ªåŠ¨åˆ·æ–°';
                document.getElementById('autoRefreshStatus').textContent = 'å·²æš‚åœ';
                showAlert('è‡ªåŠ¨åˆ·æ–°å·²æš‚åœ', 'warning');
            }
        }

        // æ˜¾ç¤ºå†å²æ•°æ®
        function showHistory() {
            if (temperatureHistory.length === 0) {
                showAlert('æš‚æ— å†å²æ•°æ®', 'warning');
                return;
            }

            const historyWindow = window.open('', '_blank', 'width=800,height=600');
            const historyHTML = `
                <html>
                <head>
                    <title>å†å²æ•°æ®</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h2>ğŸ“Š æ¸©åº¦å†å²æ•°æ®</h2>
                    <table>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>æ¸©åº¦</th>
                            <th>æ—¶é—´</th>
                        </tr>
                        ${temperatureHistory.map(point => `
                            <tr>
                                <td>${point.deviceId}</td>
                                <td>${point.temperature}Â°C</td>
                                <td>${point.time.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                </body>
                </html>
            `;
            
            historyWindow.document.write(historyHTML);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
        }

        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type}">
                    ${message}
                    <button onclick="closeAlert('${alertId}')" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeAlert(alertId);
            }, 3000);
        }

        // å…³é—­è­¦å‘Šä¿¡æ¯
        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.remove();
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeString) {
            if (!timeString) return '--';
            const date = new Date(timeString);
            return date.toLocaleString();
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // ç½‘ç»œçŠ¶æ€ç›‘å¬
        window.addEventListener('online', function() {
            console.log('ğŸŒ ç½‘ç»œå·²è¿æ¥');
            updateConnectionStatus('å·²è¿æ¥');
            refreshData();
        });

        window.addEventListener('offline', function() {
            console.log('ğŸŒ ç½‘ç»œå·²æ–­å¼€');
            updateConnectionStatus('ç½‘ç»œæ–­å¼€');
            showAlert('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'danger');
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('é¡µé¢é”™è¯¯:', event.error);
            showAlert('é¡µé¢å‘ç”Ÿé”™è¯¯: ' + event.error.message, 'danger');
        });

        // æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            showAlert('è¯·æ±‚å¤±è´¥: ' + event.reason, 'danger');
        });
    </script>
</body>
</html>
